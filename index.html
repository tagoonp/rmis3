<!DOCTYPE html>
<html>
    <head>
        <title>RMIS:ระบบสารสนเทศเพื่อการจัดการงานวิจัย คณะแพทยศาสตร์ มอ.</title>
        <!-- Meta Tags -->
        <meta charset="UTF-8" />
    		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <!-- Data table CSS -->
        <link href="v4/bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
        <!--alerts CSS -->
      	<link href="v3/vendors/bower_components/sweetalert/dist/sweetalert.css" rel="stylesheet" type="text/css">
        <!-- Fontawesom -->
        <link href="v4/bower_components/fontawesome/web-fonts-with-css/css/fontawesome-all.css" rel="stylesheet">
        <!-- Preload -->
        <link rel="stylesheet" href="v4/node_modules/preload.js/dist/css/preload.css">

        <link rel="stylesheet" href="v4/assets/css/style.css">

    </head>

    <style>
      body{
        background: rgb(246, 244, 244) !important;
      }
    </style>



    <body>

      <div class="cbsd_1 d-none d-sm-block" style="top: 0px; background: #fff; position: fixed; width: 100%; z-index: 9999999; ">
        <div style="background: #02946c !important;">
          <div class="container-fluid">
            <div class="pd-10 text-white text-right">
              ** หากพบปัญหาการใช้งาน ติดต่อ คุณณัฎฐา (กิ๊ก) หน่วยส่งเสริมและพัฒนาทางวิชาการ (<i class="fas fa-phone"></i> 1149, 1157)
            </div>
          </div>
        </div>
      </div>

      <div class="container-fluid" style="margin-top: 70px;" id="main-container">
        <div class="row">
          <div class="col-sm-5">
            <div class="row">
              <div class="col-10">
                <div class="pb-10">
                  <img src="images/logo-20190225.png" alt="" class="img-fluid">
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-body">
                <div class="row">
                  <div class="col-sm-12">


                    <h3 class="f500  text-left" style="color:  #059f84;">เข้าสู่ระบบ</h3>
                    <div class="cd">
                      <form class="loginForm" autocomplete="off" onsubmit="return false;">
                        <div class="form-group">
                          <label class="control-label f500" for="val-username">E-mail address <span class="txt-danger">**</span></label>
                          <input class="form-control" type="text" id="username" name="username" placeholder="กรอก E-mail address ..." autofocus />
                        </div>
                        <div class="form-group">
                          <label class="control-label f500" for="val-username">Password <span class="txt-danger">**</span></label>
                          <input class="form-control" type="password" id="password" name="password" placeholder="กรอกรหัสผ่าน ..." />
                        </div>
                        <div class="form-group">
                          <label class="control-label f500" for="val-username">สิทธิ์การเข้าใช้งาน <span class="txt-danger">**</span></label>
                          <select class="form-control" name="txt-role" id="txt-role">
                            <option value="pm">นักวิจัยหลัก (หัวหน้าโครงการ)</option>
                            <option value="staff">เจ้าหน้าที่</option>
                            <option value="ec">เลขา EC</option>
                            <option value="reviewer">ผู้เชี่ยวชาญอิสระ</option>
                            <option value="chairman">ประธาน EC</option>
                            <option value="administrator">ผู้ดูแลระบบ</option>
                          </select>
                        </div>


                        <div class="form-group">
                          <div class="">
                            <button name="login" type="submit" value="เข้าสู่ระบบ" class="btn btn-success btn-block ">เข้าสู่ระบบ</button>
                            <button name="register" type="button" value="สมัครใช้งานสำหรับบุคลภายนอกคณะ" class="btn btn-success btn-block" onclick="window.location = 'register.html'">สมัครใช้งานสำหรับบุคคลภายนอกคณะ</button>
                          </div>
                        </div>
                      </form>
                    </div>


                  </div>
                </div>
                <div class="row">
                  <div class="col-sm-12 text-left" style="color:rgb(115, 115, 115);">

                    <a href="#" class="txt-success" onclick="showModal('myModal_resetpassword')">ลืมรหัสผ่าน</a>

                    <div class="d-block d-sm-none">
                      <div class="col-sm-12 text-left pt-10"  style="padding-left: 0px;">
                        <div class="pb-10">
                          <a href="#" class="mr-5">ข่าวประกาศ</a>
                        </div>
                        <div class="pb-10">
                          <a href="#" class="mr-5">แนะนำการใช้งาน</a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- .card-body -->
            </div>
            <!-- .card -->

            <div class="pd-10" style="font-size: 0.8em;">
              <div class="row">
                <div class="col-sm-12 text-left" style="color:rgb(115, 115, 115);">
                  <h5 class="f500 pt-10">RMIS :: Research Management Information System</h5>
                  Copyright &copy; 2013 หน่วยส่งเสริมและพัฒนาทางวิชาการ<br>คณะแพทยศาสตร์ มหาวิทยาลัยสงขลานครินทร์
                </div>
                <div class="col-sm-12 text-left pt-10">
                  <a href="#" class="mr-5">นโยบายความเป็นส่วนตัว</a> |
                  <a href="#" class="mr-5 ml-5">ความปลอดภัย</a> |
                  <a href="http://medinfo2.psu.ac.th/research/hrec/" class="ml-5" target="_blank">ติดต่อเรา</a>
                </div>
              </div>
            </div>
          </div>
          <!-- .col-sm-5 -->
          <div class="col-sm-7  d-none d-sm-block">
            <div>
              <h5 class="f500" style="border: dashed; border-width: 0px 0px 2px 0px; border-color: rgb(232, 232, 232);"><i class="fa fa-rss"></i> ข่าวประกาศ</h5>

              <div class="pd-10 mt-10 pt-0 fs08" style="background: #fff; border-radius: 0px; border: solid; border-width: 0px 0px 0px 3px; border-color: rgb(255, 0, 38); cursor: pointer;" onclick="showModal('NewsModal1')" id="">
                <img src="images/new-gif-image-14.gif" alt="" style="width: 40px;"> ขอความร่วมมือสำหรับโครงการ Multicenter sponsor trial <small class="text-danger">[Click เพื่ออ่าน]</small>
              </div>

            </div>

            <div class="pt-10 ">
              <h5 class="f500" style="border: dashed; border-width: 0px 0px 2px 0px; border-color: rgb(232, 232, 232);"><i class="fa fa-info"></i> แนะนำการใช้งาน</h5>
              <div class="pd-10 mt-10 pt-0 fs08" style="background: #fff; border-radius: 0px; border: solid; border-width: 0px 0px 0px 3px; border-color: rgb(2, 167, 88);">
                <h5 class="mb-15"><span class="f500">เฉพาะบุคลากรคณะแพทย์</span> <u>(การเข้าระบบครั้งแรก)</u></h5>
                <p class="txt-dark" style="color: #000;">
                  <ol style="padding-left: 30px; padding-bottom: 10px;"  class="txt-dark">
                    <li>Username = รหัสบุคลากร </li>
                    <li>Password = วันเกิด ใช้ปี คศ. (dd/mm/yyyy) เช่น 07/08/1982 </li>
                  </ol>
                  <span class="txt-dark">ระบบจะเข้าสู่หน้าข้อมูลส่วนตัว ให้ท่านทำการตรวจสอบข้อมูลและแก้ไขให้ถูกต้อง <br>บันทึกชื่อ e-mail ที่จะใช้เป็น user name  และกำหนด password ใหม่ กดปุ่มบันทึก</span>
                  <p class="f500 txt-danger pt-10" style="font-size: 0.9em;">
                    * การเข้าใช้งานครั้งต่อไป ต้องใช้ e-mail address และ password ดังกล่าวเพื่อเข้าระบบ
                  </p>
                </p>
              </div>

              <div class="pd-10 mt-10 pt-0 fs08" style="background: #fff; border-radius: 0px; border: solid; border-width: 0px 0px 0px 2px; border-color: rgb(2, 167, 88);">
                <h5 class="mb-15"><span class="f500">สำหรับบุคลากรภายนอกคณะแพทย์</span> ให้ดำเนินการดังนี้เพื่อเริ่มต้นใช้งาน</h5>
                <p class="txt-dark" style="color: #000;">
                  <ol style="padding-left: 30px; padding-bottom: 10px;"  class="txt-dark">
                    <li>กดปุ่ม "สมัครใช้งานสำหรับบุคคลภายนอกคณะแพทย์" </li>
                    <li>กรอกข้อมูลในแบบฟอร์มลงทะเบียนเพื่อใช้งานระบบ (สำหรับบุคคลภายนอกคณะแพทยศาสตร์) ให้ครบถ้วน และกดปุ่ม "ลงทะเบียน"</li>
                    <li>หากลงทะเบียนสำเร็จ ระบบจะส่งอีเมล์ไปยังอีเมลที่ท่านทำการสมัครเพื่อให้กด Link เพื่อยืนยันตัวตนอีกครั้ง</li>
                    <li>เมื่อยืนยันตัวตนสำเร็จ ท่านสามารถใช้อีเมล์และรหัสผ่านที่สมัครเข้าสู่ระบบได้</li>
                  </ol>
                </p>
              </div>

            </div>
          </div>
          <!-- .col-sm-7 -->
        </div>
      </div>

      <!-- sample modal content -->
      <div id="myModal_resetpassword" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog  modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel" style="font-weight: 400;">ลืมรหัสผ่าน</h5>
              <button type="button" class="close btnClosemodal" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form class="register-form" onsubmit="return false;">
                <div class="form-group">
                  <label for="" class="f500 txt-dark fs08">กรอก E-mail address ที่ท่านใช้สมัคร <span class="text-danger">**</span></label>
                  <input type="email" class="form-control" placeholder="E-mail address ของท่าน ... " id="txtPassword2"/>
                </div>

                <button class="f500 btn btn-block btn-success" onclick="sendPassword()"  style="font-size: 1.1em; padding: 10px 0px;">ส่งรหัสผ่าน</button>
              </form>
            </div>
          </div>
          <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
      </div>
      <!-- /.modal -->

      <!-- sample modal content -->
      <div id="NewsModal1" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header" style="background: rgb(255, 0, 61);">
              <h5 class="modal-title" id="exampleModalLabel" style="font-weight: 400;">ประกาศ</h5>
              <button type="button" class="close btnClosemodal text-white" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body pb-5">
              <p>
                <div class="text-center pb-20">
                  <i class="fas fa-exclamation-triangle text-danger fa-5x"></i>
                </div>
                <h4 class="text-center">ขอความร่วมมือ</h4>
                <p class="text-center">
                  โครงการวิจัยที่เป็น Multicenter Sponsor Trial ขอให้ยื่นโครงการเพื่อขอรับรองที่ CREC กรณีมีข้อสงสัยให้โทรสอบถามเจ้าหน้าที่สำนักงานหน่วยส่งเสริมและพัฒนาทางวิชาการ (1149, 1157)
                </p>
                <div class="text-right pt-10">
                  <button class="btn btn-secondary btn-block" onclick="$('.btnClosemodal').trigger('click')">ปิด</button>
                </div>
              </p>
            </div>
          </div>
          <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
      </div>
      <!-- /.modal -->

    <!-- jQuery -->
    <script src="v3/vendors/bower_components/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap Core JavaScript -->
    <script src="v4/bower_components/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Slimscroll JavaScript -->
    <script src="v3/dist/js/jquery.slimscroll.js"></script>
    <!-- Fancy Dropdown JS -->
    <script src="v3/dist/js/dropdown-bootstrap-extended.js"></script>
    <!-- Sweet-Alert  -->
    <script src="v3/vendors/bower_components/sweetalert/dist/sweetalert.min.js"></script>

    <script src="v4/config.js"></script>

    <script type="text/javascript" src="v4/node_modules/preload.js/dist/js/preload.js"></script>

    <!-- Sweet-Alert  -->
    <script src="v3/main.js"></script>

    <script type="text/javascript">

      $(document).ready(function(){

        preload.hide()

        localStorage.clear();

        $w = $('body').width()
        if($w <= 475){
          $('#main-container').css('margin-top', '20px')
        }else{
          $('#main-container').css('margin-top', '60px')
        }

        showModal('NewsModal1')
      })

      function showModal(id){
        $("#" + id).modal();
      }

      $(function(){

        $('.loginForm').submit(function(){
            $check = 0;
            $('.form-control').removeClass('is-invalid')
            if($('#username').val()==''){
              $check++;
              $('#username').addClass('is-invalid')
            }

            if($('#password').val()==''){
              $check++;
              $('#password').addClass('is-invalid')
            }

            if($('#txt-role').val()==''){
              $check++;
              $('#txt-role').addClass('is-invalid')
            }

            if($check!=0){
              swal("ขออภัย!", "กรุณากรอกข้อมูลให้ครบถ้วน!", "error")
              return ;
            }

            preload.show()

            var param = {
              username: $('#username').val(),
              password: $('#password').val(),
              role: $('#txt-role').val()
            }

            var jxhr = $.post(ws_url + 'controller/authen.php', param, function(){}, 'json')
                        .always(function(snap){
                          // console.log(snap);
                          // return ;
                          if((snap!='') && (snap.length > 0)){
                            snap.forEach(function(i){

                              console.log(i.authen_status );

                              if(i.authen_status == 'Already register'){
                                localStorage.setItem('rmis_current_id_pm', $('#username').val())
                                window.location = 'already-register.html';
                              }else if(i.authen_status == 'Found by useraccount'){

                                window.localStorage.setItem('rmis_current_user', i.data.id)
                                window.localStorage.setItem('rmis_current_role', $('#txt-role').val())

                                setTimeout(function(){
                                  window.location = ws_url + $('#txt-role').val() + '/';
                                }, 2000)


                              }else if(i.authen_status == 'Found by personnel'){
                                localStorage.setItem('rmis_current_id_pm', $('#username').val())
                                window.location = 'personnel-register.html';
                              }else{

                                preload.hide()
                                swal("ขออภัย!", "ไม่พบข้อมูลบัญชีผู้ใช้งานระบบ!", "error")
                                return ;
                              }

                            })

                          }else{
                            preload.hide()
                            swal("ขออภัย!", "ไม่พบข้อมูลบัญชีผู้ใช้งานระบบ!", "error")
                            return ;
                          }
                        }, 'json')
                        .fail(function(resp){
                          console.log(resp);
                          preload.hide()
                          swal("ขออภัย!", "ไม่สามารถเชื่อมต่อฐานข้อมูลได้!", "error")
                          return ;
                        })

        })

      })

      function sendPassword(){
        $pwd = $('#txtPassword2').val()
        $check = 0;
        $('.form-control').removeClass('is-invalid')

        if($('#txtPassword2').val()==''){
          $('#txtPassword2').addClass('is-invalid')
          $check++;
        }

        if($check!=0){
          swal("ขออภัย!", "กรุณากรอกข้อมูลให้ครบถ้วน!", "error")
          return ;
        }

        preload.show()

        var param = {
          email: $pwd
        }

        var jxhr = $.post(ws_url + 'controller/getPassword.php', param, function(){}, 'json')
                    .always(function(snap){

                      if((snap!='') && (snap.length > 0)){
                        snap.forEach(function(i){
                          var dataContent = '<h3>แจ้งรหัสผ่านสำหรับการเข้าใช้งานระบบ RMIS </h3>' +
                                            '<p>เรียน คุณ' + i.fname + ' ' + i.lname + '</p>' +
                                            '<p>เนื่องจากท่านได้ทำการขอทราบรหัสผ่านเพื่อเข้าใช้งานระบบสารสนเทศเพื่อการจัดการงานวิจัย (RMIS) ทั้งนี้ ท่านสามารถเข้าใช้งานระบบได้ทาง <a href="' + root_domain + '" target="_blank">' + root_domain + '</a> โดยใช้ข้อมูลดังต่อไปนี้' +
                                            '</p>' +
                                            '<p>ชื่อบัญชีผู้ใช้ : ' + $pwd + '<br>รหัสผ่าน <span style="color:red;">: ' + i.password + '<span></p>' +
                                            '<p>จึงเรียนมาเพื่อทราบ <br>ระบบสารสนเทศเพื่อการจัดการงานวิจัย (RMIS)</p>' + '<p style="color:red;">** กรุณาเก็บข้อมูลอีเมล์ฉบับนี้ไว้เนื่องจากท่านอาจต้องใช้ในอนาคต</p>'

                                            var param = {
                                              title: '{ No-reply } แจ้งรหัสผ่านสำหรับการเข้าใช้งานระบบ RMIS',
                                              content: dataContent,
                                              user: 'tagoon.p@gmail.com',
                                              key: 'idj&skeoXf2**r123X',
                                              toemail: $pwd,
                                              toname: i.fname + ' ' + i.lname
                                            }

                                            // main.send_email(param,
                                            //   'reload',
                                            //   'ระบบได้ทำการส่งข้อมูลรหัสผ่านไปยังอีเมล์ของท่านเรียบร้อยแล้ว',
                                            //   'ระบบได้ดำเนินการตามกระบวนที่ท่านได้ดำเนินการแล้ว แต่เกิดข้อผิดพลาดในส่วนของการส่งอีเมล์ กรุณาแจ้งเจ้าหน้าที่เพื่อตรวจสอบและดำเนินการแก้ไข')
                                            // return ;

                                            var jxr = $.post('http://simanh.psu.ac.th/icustomsystem/mailer/sender.php', param, function(){})
                                                       .always(function(resp){
                                                         if(resp == 'Y'){
                                                           preload.hide()
                                                           try {
                                                             preload.hide()
                                                           } catch (e) {

                                                           } finally {

                                                           }
                                                           swal({
                                                             title: "ดำเนินการสำเร็จ",
                                                             text: 'ระบบได้ทำการส่งข้อมูลรหัสผ่านไปยังอีเมล์ของท่านเรียบร้อยแล้ว',
                                                             type: "success",
                                                             showCancelButton: false,
                                                             confirmButtonColor: "#126cd5",
                                                             confirmButtonText: "ตกลง",
                                                             closeOnConfirm: true
                                                           },
                                                           function(){
                                                             window.location.reload();
                                                           });

                                                         }else{
                                                           preload.hide()
                                                           swal({
                                                             title: "คำเตือน",
                                                             text: 'ระบบได้ดำเนินการตามกระบวนที่ท่านได้ดำเนินการแล้ว แต่เกิดข้อผิดพลาดในส่วนของการส่งอีเมล์ กรุณาแจ้งเจ้าหน้าที่เพื่อตรวจสอบและดำเนินการแก้ไข',
                                                             type: "warning",
                                                             showCancelButton: false,
                                                             confirmButtonColor: "#126cd5",
                                                             confirmButtonText: "ตกลง",
                                                             closeOnConfirm: true
                                                           },
                                                           function(){
                                                             window.location.reload()
                                                           });
                                                         }
                                                       })
                                                       return ;

                          var emailParam = {
                            email: emailConfig.user,
                            api_key: emailConfig.key,
                            title: "{ No-reply } แจ้งรหัสผ่านสำหรับการเข้าใช้งานระบบ RMIS",
                            to_email: $pwd,
                            content: dataContent
                          }

                          var jxhr2 = $.post(emailProvider, emailParam, function(){})
                                      .always(function(res){
                                        if(res=='Y'){
                                          preload.hide()
                                          swal({
                                          title: "ส่งข้อมูลสำเร็จ",
                                          text: "ระบบได้ทำการส่งข้อมูลรหัสผ่านไปยังอีเมล์ของท่านเรียบร้อยแล้ว",
                                          type: "success",
                                          showCancelButton: false,
                                          confirmButtonColor: "#DD6B55",
                                          confirmButtonText: "รับทราบ",
                                          closeOnConfirm: false },
                                          function(){
                                            window.location.reload()
                                          });
                                        }else{
                                          swal("เกิดข้อผิดพลาด!", "ระบบไม่สามารถส่งข้อมูลไปยัง E-mail ของท่านได้ กรุณาติดต่อเจ้าหน้าที่เพื่อขอทราบรหัสผ่าน", "error")
                                          preload.hide();
                                        }
                                      })
                        })
                        return ;
                      }else{
                        preload.hide()
                        swal("ขออภัย!", "ไม่พบข้อมูลผู้ใช้งาน กรุณาติดต่อเจ้าหน้าที่!", "error")
                        return ;
                      }
                    }, 'json')
                    .fail(function(){
                      preload.hide()
                      swal("ขออภัย!", "ไม่สามารถเชื่อมต่อฐานข้อมูลได้!", "error")
                      return ;
                    })

      }
    </script>
</body>
</html>
