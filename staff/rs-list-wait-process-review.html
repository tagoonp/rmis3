<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv='cache-control' content='no-cache'>
  <meta http-equiv='expires' content='0'>
  <meta http-equiv='pragma' content='no-cache'>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<title>:: RMIS :: สำหรับเจ้าหน้าที่ ::</title>

	<!-- Data table CSS -->
	<link href="../v3/vendors/bower_components/datatables/media/css/jquery.dataTables.min.css" rel="stylesheet" type="text/css"/>

  <!--alerts CSS -->
	<link href="../v3/vendors/bower_components/sweetalert/dist/sweetalert.css" rel="stylesheet" type="text/css">

  <!-- Data table CSS -->
  <link href="../v3/vendors/bower_components/datatables/media/css/jquery.dataTables.min.css" rel="stylesheet" type="text/css"/>

	<!-- Custom CSS -->
	<link href="../v3/dist/css/style.css" rel="stylesheet" type="text/css">
  <link href="../v3/fonts.css" rel="stylesheet" type="text/css">
  <link href="../v3/style.css" rel="stylesheet" type="text/css">

  <style media="screen">
    .badge-1{
      background: rgb(228, 228, 228);
    }

    .badge-2{
      background: rgb(255, 51, 51);
      color: #fff !important;
      padding: 3px 5px;
    }
  </style>
</head>

<body>
	<!--Preloader-->
	<div class="preloader-it">
		<div class="la-anim-1"></div>
	</div>
	<!--/Preloader-->
    <div class="wrapper theme-1-active pimary-color-red">

        <!-- Top Menu Items -->
		<nav class="navbar navbar-inverse navbar-fixed-top">
			<div class="mobile-only-brand pull-left">
				<div class="nav-header pull-left">
					<div class="logo-wrap">
						<a href="index.html">
							<img class="brand-img" src="../v3/dist/img/logo.png" alt="brand"/>
							<span class="brand-text">RMIS</span>
						</a>
					</div>
				</div>
				<a id="toggle_nav_btn" class="toggle-left-nav-btn inline-block ml-20 pull-left" href="javascript:void(0);"><i class="zmdi zmdi-menu"></i></a>
				<a id="toggle_mobile_nav" class="mobile-only-view" href="javascript:void(0);"><i class="zmdi zmdi-more"></i></a>
			</div>
			<div id="mobile_only_nav" class="mobile-only-nav pull-right">
				<ul class="nav navbar-right top-nav pull-right">
          <li>
            <a href="profile.html">ยินดีต้อนรับ <span class="userFullname text-info">NA</span> (STAFF)</a>
          </li>
					<li class="dropdown alert-drp">
						<a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="zmdi zmdi-notifications top-nav-icon"></i><span class="notification_number"></span></a>
						<ul  class="dropdown-menu alert-dropdown" data-dropdown-in="bounceIn" data-dropdown-out="bounceOut">
							<li>
								<div class="notification-box-head-wrap">
									<span class="notification-box-head pull-left inline-block">การแจ้งเตือน</span>
									<a class="txt-danger pull-right clear-notifications inline-block" href="javascript:main.clear_notify()"> ล้างทั้งหมด </a>
									<div class="clearfix"></div>
									<hr class="light-grey-hr ma-0"/>
								</div>
							</li>
              <li>
                <div class="streamline message-nicescroll-bar notification_panal">
                </div>
              </li>
							<li>
								<div class="notification-box-bottom-wrap">
									<hr class="light-grey-hr ma-0"/>
									<a class="block text-center read-all" href="view_activity_log.html"> อ่านทั้งหมด </a>
									<div class="clearfix"></div>
								</div>
							</li>
						</ul>
					</li>
					<li class="dropdown auth-drp">
						<a href="#" class="dropdown-toggle pr-0" data-toggle="dropdown"><span id="profileImg"></span><span class="user-online-status"></span></a>
						<ul class="dropdown-menu user-auth-dropdown" data-dropdown-in="flipInX" data-dropdown-out="flipOutX">
							<li>
								<a href="profile.html"><i class="zmdi zmdi-account"></i><span>ข้อมูลส่วนตัว</span></a>
							</li>
							<li>
								<a href="#" onclick="main.mailbox()"><i class="zmdi zmdi-email"></i><span>Inbox</span></a>
							</li>
							<li>
								<a href="changepassword.html"><i class="zmdi zmdi-settings"></i><span>เปลี่ยนรหัสผ่าน</span></a>
							</li>
							<li class="divider"></li>
							<li>
								<a href="#" onclick="main.signout()"><i class="zmdi zmdi-power"></i><span>ออกจากระบบ</span></a>
							</li>
						</ul>
					</li>
				</ul>
			</div>
		</nav>
		<!-- /Top Menu Items -->

		<!-- Left Sidebar Menu -->
		<div class="fixed-sidebar-left">
			<ul class="nav navbar-nav side-nav nicescroll-bar">
				<li class="navigation-header">
					<span>Main</span>
					<i class="zmdi zmdi-more"></i>
				</li>

        <li>
					<a href="./"><div class="pull-left"><i class="zmdi zmdi-home mr-20"></i><span class="right-nav-text">หน้าแรก</span></div><div class="clearfix"></div></a>
				</li>
        <li>
						<a href="javascript:void(0);" data-toggle="collapse" data-target="#dashboard_dr"><div class="pull-left"><i class="zmdi zmdi-landscape mr-20"></i><span class="right-nav-text">กระดานภาพรวม</span></div><div class="pull-right"><i class="zmdi zmdi-caret-down"></i></div><div class="clearfix"></div></a>
						<ul id="dashboard_dr" class="collapse collapse-level-1">
							<li>
								<a href="dashboard_1.html">ภาพรวมโครงการวิจัย</a>
							</li>
						</ul>
					</li>

				<li><hr class="light-grey-hr mb-10"/></li>
				<li class="navigation-header">
					<span>อื่น ๆ</span>
					<i class="zmdi zmdi-more"></i>
				</li>

        <li>
					<a href="documentation.html"><div class="pull-left"><i class="zmdi zmdi-book mr-20"></i><span class="right-nav-text">คู่มือการใช้งาน (STAFF)</span></div><div class="clearfix"></div></a>
				</li>

			</ul>
		</div>
		<!-- /Left Sidebar Menu -->


		<!-- Main Content -->
		<div class="page-wrapper" style="padding-left: 15px; padding-right: 15px;">
      <div class="container-fluid">

				<!-- Title -->
				<div class="row heading-bg">
					<div class="col-lg-3 col-md-4 col-sm-4 col-xs-12">
						<h5 class="txt-dark">โครงการวิจัยรอสรุปข้อเสนอแนะ</h5>
					</div>
					<!-- Breadcrumb -->
					<div class="col-lg-9 col-sm-8 col-md-8 col-xs-12">
						<ol class="breadcrumb">
							<li><a href="./">หน้าแรก</a></li>
							<li class="active"><span>โครงการวิจัยรอสรุปข้อเสนอแนะ</span></li>
						</ol>
					</div>
					<!-- /Breadcrumb -->
				</div>
				<!-- /Title -->

        <!-- Row -->
        <div class="row">
          <div class="col-sm-12">
            <div class="form-group">
              <label for="" class="f500 txt-dart">ปี พ.ศ. :</label>
              <select class="form-control" name="txtYear" id="txtYear">

              </select>
            </div>
          </div>
          <div class="col-sm-12">
            <div class="panel panel-default card-view">


              <div class="panel-wrapper collapse in">
                <div class="panel-body">

                  <div class="table-wrap">
										<div class="table-responsive_">
											<table id="datable_1" class="table table-hover display  pb-30" >
												<thead>
													<tr>
														<th style="width: 30px;">#</th>
                            <th style="width: 80px;">รหัสโครงการ</th>
														<th>โครงการวิจัย</th>
														<th style="">ผู้เชี่ยวชาญอิสระ</th>
														<th style="width: 180px;">สถานะ</th>
														<th style="width: 130px;"></th>
													</tr>
												</thead>
												<tbody>

												</tbody>
											</table>
										</div>
									</div>

                </div>
                <!-- .panel-body -->
              </div>
              <!-- .panel-wrapper -->
            </div>
            <!-- .panel -->
          </div>





        </div>
        <!-- .Row -->



				<!-- Footer -->
				<footer class="footer container-fluid pl-30 pr-30">
					<div class="row">
						<div class="col-sm-12">
							<p>2017 &copy; <a href="http://rmis.medicine.psu.ac.th/project/" target="_blank">RMIS</a>. หน่วยส่งเสริมและพัฒนาทางวิชาการ คณะแพทยศาสตร์ มหาวิทยาลัยสงขลานครินทร์. Develop by <a href="https://wisniorproject.com" target="_blank">Wisnior Corp.</a></p>
						</div>
					</div>
				</footer>
				<!-- /Footer -->
			</div>
		</div>
        <!-- /Main Content -->

    </div>
    <!-- /#wrapper -->

	<!-- JavaScript -->

  <!-- jQuery -->
  <script src="../v3/vendors/bower_components/jquery/dist/jquery.min.js"></script>

  <!-- Bootstrap Core JavaScript -->
  <script src="../v3/vendors/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

	<!-- Data table JavaScript -->
	<script src="../v3/vendors/bower_components/datatables/media/js/jquery.dataTables.min.js"></script>
	<script src="../v3/dist/js/dataTables-data.js"></script>

	<!-- Slimscroll JavaScript -->
	<script src="../v3/dist/js/jquery.slimscroll.js"></script>

	<!-- Owl JavaScript -->
	<script src="../v3/vendors/bower_components/owl.carousel/dist/owl.carousel.min.js"></script>

	<!-- Switchery JavaScript -->
	<script src="../v3/vendors/bower_components/switchery/dist/switchery.min.js"></script>

	<!-- Fancy Dropdown JS -->
	<script src="../v3/dist/js/dropdown-bootstrap-extended.js"></script>

  <!-- Sweet-Alert  -->
	<script src="../v3/vendors/bower_components/sweetalert/dist/sweetalert.min.js"></script>

  <!-- Data table JavaScript -->
  <script src="../v3/vendors/bower_components/datatables/media/js/jquery.dataTables.min.js"></script>
  <script src="../v3/dist/js/dataTables-data.js"></script>

	<!-- Init JavaScript -->
	<script src="../v3/dist/js/init.js"></script>
  <script src="../v3/main.js"></script>
  <script src="../v3/staff.js"></script>

  <script type="text/javascript">

    var current_user = window.localStorage.getItem('rmis_current_user')
    var current_role = window.localStorage.getItem('rmis_current_role')

    $(document).ready(function(){
      staff.init()
      main.load_year();
      // loadList();

      setTimeout(function(){
        var dt = new Date();
        var cyear = parseInt(dt.getFullYear()) - 1999;
        $('#txtYear').val(cyear);
        loadList()
      }, 1000)

    })

    $(function(){
      $('#txtYear').change(function(){
        loadList()
      })
    })

    function loadList(){
      var param = {
        id_year: $('#txtYear').val()
      }
      var param = $.post(ws_url + 'controller/staff/check-new-wait-process-review.php', param ,function(){},'json')
                   .always(function(snap){

                     console.log(snap);

                     var dt = $('#datable_1').dataTable().api();
                     if((snap!='') && (snap.length > 0)){

                      console.log(snap);

                       dt.clear().draw();
                       $c = 1;
                       snap.forEach(function(i){

                         $bt1 = '';
                         $bt2 = '';
                         $bt3 = '';

                         if((i.id_status_research != 1) && (i.id_status_research != 2) && (i.id_status_research != 9)) {
                           $bt2 = 'disabled ';
                         }

                         if((i.id_status_research == 10) || (i.id_status_research == 11) || (i.id_status_research == 12) || (i.id_status_research == 13) || (i.id_status_research == 14) || (i.id_status_research == 16)  || (i.id_status_research == 18)) {
                           $bt3 = 'disabled ';
                         }

                         var command_btn = '<div class="text-center" style="width: 140px !important; float: right;"><div class="btn-group btn-group-xs" role="group">' +
                           '<button class="btn btn-success btn-xs btn-icon-anim btn-square" onclick=viewRsInfo3("' + i.id_rs +'") data-toggle="tooltip" data-placement="top" title="ดำเนินการต่อ"><i class="fa fa-wrench"></i></button>' +
                           '<button class="btn btn-danger btn-xs btn-icon-anim btn-square" ' + $bt3 + ' onclick=widthdraw_research("' + i.id_rs +'") data-toggle="tooltip" data-placement="top" title="ลบรายงาน"><i class="fa fa-close"></i></button>' +
                         '</div></div>';

                         var code = i.code_apdu;

                         if(code == ''){
                           if(i.ord_id == ''){
                             code = '<div style="font-size: 0.8em;" class="txt-danger">ยังไม่ได้ยืนยันการส่งข้อมูล</div>'
                           }else{
                             code = i.year_name + '-' + i.ord_id + '-' + i.id_dept + '-' + i.id_personnel + '<div style="font-size: 0.8em;" class="txt-danger">ยังไม่ได้การตรวจสอบจากเจ้าหน้าที่</div>'
                           }
                         }

                         var param = {
                           rir_id_rs: i.id_rs
                         }

                         var rw_string = '';

                         var ec_info = ''

                         if((i.contype == 'Fullboard (Social)') || (i.contype == 'Fullboard (Bio)')){
                           ec_info = '<div style="font-size: 0.8em;">เลขาการประชุม (Fullboard) : ' + i.ec_fname + ' ' + i.ec_lname + '</div>'
                         }

                         var jxh = $.post(ws_url + 'controller/staff/check-new-wait-process-reviewer.php', param, function(){}, 'json')
                                    .always(function(snap2){
                                        console.log(snap2);

                                        if((snap2!='') && (snap2.length > 0)){
                                          snap2.forEach(function(j){



                                            if(j.rw_sending_status != 0){
                                              if(j.rw_reply_status == 0){
                                                var dateDifference = datediff(parseDate(j.rw_sending_datetime, true), parseDate(j.rw_sending_expire_date, false));
                                                var expirestring = ''

                                                if((dateDifference >= 10) && (dateDifference <= 14)){
                                                  expirestring = '<span class="text-warning badge badge-1"><i class="zmdi zmdi-notifications-active"></i> ใกล้ deadline </span> '
                                                }

                                                if(dateDifference > 14){
                                                  expirestring = '<span class="text-danger badge badge-2" style="color: #fff;"><i class="zmdi zmdi-alert-triangle"></i> เลย Due date </span> '
                                                }
                                                rw_string += '<div style="font-size: 0.8em; padding-bottom: 5px;"><span class="txt-dark">' + j.fname + ' ' + j.lname + ' (' + j.rir_status + ')</span><br>' + '<span>สถานะการตอบ : <span class="txt-danger">ยังไม่ตอบรับ (ส่งไปแล้ว ' + dateDifference + ' วัน) ' + expirestring + '</span></span></div>'
                                              }else if(j.rw_reply_status == 1){
                                                var dateDifference = datediff(parseDate(j.rw_sending_datetime, true), parseDate(j.rw_sending_expire_date, false));
                                                var expirestring = ''
                                                if((dateDifference >= 10) && (dateDifference <= 14)){
                                                  expirestring = '<span class="text-warning badge badge-1"><i class="zmdi zmdi-notifications-active"></i> ใกล้ deadline </span> '
                                                }

                                                if(dateDifference > 14){
                                                  expirestring = '<span class="text-danger badge badge-2" style="color: #fff;"><i class="zmdi zmdi-alert-triangle"></i> เลย Due date </span> '
                                                }
                                                rw_string += '<div style="font-size: 0.8em; padding-bottom: 5px;"><span class="txt-dark">' + j.fname + ' ' + j.lname + ' (' + j.rir_status + ')</span><br>' + '<span>สถานะการตอบ : <span class="txt-success">ตอบรับการพิจารณา (ส่งไปแล้ว ' + dateDifference + ' วัน) ' + expirestring + '</span></span></div>'
                                              }else if(j.rw_reply_status == 2){
                                                rw_string += '<div style="font-size: 0.8em; padding-bottom: 5px;"><span class="txt-dark">' + j.fname + ' ' + j.lname + ' (' + j.rir_status + ')</span><br>' + '<span>สถานะการตอบ : <span class="txt-warning">ตอบรับการพิจารณาโดยขอเอกสาร (Hard copy)</span></span></div>'
                                              }else if(j.rw_reply_status == 3){
                                                rw_string += '<div style="font-size: 0.8em; padding-bottom: 5px;"><span class="txt-dark">' + j.fname + ' ' + j.lname + ' (' + j.rir_status + ')</span><br>' + '<span>สถานะการตอบ : <span class="txt-danger">ขอไม่พิจารณาโครงการ</span></span></div>'
                                              }else if(j.rw_reply_status == 4){
                                                rw_string += '<div style="font-size: 0.8em; padding-bottom: 5px;"><span class="txt-dark">' + j.fname + ' ' + j.lname + ' (' + j.rir_status + ')</span><br>' + '<span>สถานะการตอบ : <span class="txt-success">ได้รับผลประเมินจากผู้เชี่ยวชาญแล้ว</span></span></div>'
                                              }
                                            }else{
                                              rw_string += '<div style="font-size: 0.8em; padding-bottom: 5px;"><span class="txt-dark">' + j.fname + ' ' + j.lname + ' (' + j.rir_status + ')</span><br>' + '<span>สถานะการตอบ : <span class="text-muted">ยังไม่ได้ส่ง</span></span></div>'
                                            }
                                          })

                                          $prj_title = i.title_th
                                          if(i.title_th == '-'){
                                            $prj_title = i.title_en
                                          }

                                          dt.row.add([
                                            $c,
                                            i.code_apdu,
                                            '<a href="#" onclick=viewRsInfo("' + i.id_rs +'") class="f500">' + $prj_title + '</a><div style="font-size: 0.8em;"> ประเภทการพิจารณา : <span class="text-danger">' + i.contype + '</span></div><div style="font-size: 0.8em;">หัวหน้าโครงการวิจัย : ' + i.fname + ' ' + i.lname + '</div>' + ec_info + '<div style="font-size: 0.8em;">ลงทะเบียนเมื่อ : ' + main_app.convertThaidatetime(i.date_submit) + '</div>',
                                            rw_string,
                                            '<span class="txt-danger">' + i.status_name +'</span>',
                                            command_btn
                                          ]);
                                          $c++;
                                          dt.draw();

                                        }else{
                                          dt.row.add([
                                            $c,
                                            i.code_apdu,
                                            '<a href="#" onclick=viewRsInfo("' + i.id_rs +'") class="f500">' + i.title_th + '</a><div style="font-size: 0.8em;">หัวหน้าโครงการวิจัย : ' + i.fname + ' ' + i.lname + '</div>' + ec_info + '<div style="font-size: 0.8em;">ลงทะเบียนเมื่อ : ' + main_app.convertThaidatetime(i.date_submit) + '</div>',
                                            rw_string,
                                            '<span class="txt-danger">' + i.status_name +'</span>',
                                            command_btn
                                          ]);
                                          $c++;
                                          dt.draw();
                                        }
                                    }, 'json')



                       })


                     }else{
                       dt.clear().draw();
                     }
                   }, 'json')
    }

    function parseDate(str, is_datetime) {
      if(is_datetime){
        var mdy = str.split(' ');
        var mdy2 = mdy[0].split('-');
        console.log(mdy2);
        return new Date(mdy2[0], parseInt(mdy2[1])-1, mdy2[0]);
      }else{
        var mdy2 = str.split('-');
        console.log(mdy2);
        return new Date(mdy2[0], parseInt(mdy2[1])-1, mdy2[0]);
      }
    }

    function datediff(first, second) {
        // Take the difference between the dates and divide by milliseconds per day.
        // Round to nearest whole number to deal with DST.
        return Math.round((second-first)/(1000*60*60*24));
    }


  </script>
</body>

</html>
